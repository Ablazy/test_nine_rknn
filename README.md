# test_nine项目的rknn实现

原项目来自：https://github.com/luguoyixiazi/test_nine
验证码识别，用于极验的九宫格验证码（例如米游社论坛签到验证码）。

部署在具有NPU的瑞芯微（Rockchip）SoC的开发板上，并使用NPU推理模型。

目前实现了PP-HGNetV2-B4模型的NPU推理，可用于九宫格验证。

点选验证使用的d-fine-n模型，由于rknn不支持GridSample算子。目前使用C API构建了自定义的cstGridSample算子。为了方便输入，将原始模型的第二个输入orig_target_sizes设计为了4维，并在之后添加了reshape，此操作不影响模型推理。同时，由于rknn最多支持float16的数据推理，原始模型在推理中，个别clip算子会导致数据溢出，产生`inf`，因此同样对这些clip算子进行了调整，调整后模型精度影响不大。

## 关于自定义算子

目前实现的是rk3588上CPU层面的GridSample自定义算子，只实现了功能，未针对运行效率做优化，算子效率较低，具体体现在模型中如下：

```shell
---------------------------------------------------------------------------------------------------
                                  Operator Time Consuming Ranking Table            
---------------------------------------------------------------------------------------------------
OpType             CallNumber   CPUTime(us)  GPUTime(us)  NPUTime(us)  TotalTime(us)  TimeRatio(%)  
---------------------------------------------------------------------------------------------------
cstGridSample      6            70746        0            0            70746          38.24%        
Transpose          36           0            0            35403        35403          19.14%        
exSDPAttention     4            0            0            15254        15254          8.25%         
Mul                69           25           0            8973         8998           4.86%         
Add                67           0            0            7264         7264           3.93%         
ConvRelu           47           0            0            6404         6404           3.46%         
GatherElements     3            5685         0            0            5685           3.07%         
Concat             21           0            0            5652         5652           3.06%         
Conv               49           0            0            5447         5447           2.94%         
Reshape            46           1893         0            2552         4445           2.40%         
exSoftmax13        7            0            0            4273         4273           2.31%         
TopK               3            3553         0            0            3553           1.92%         
exNorm             12           0            0            2516         2516           1.36%         
Split              16           0            0            2073         2073           1.12%         
ConvExSwish        24           0            0            1580         1580           0.85%         
ConvAdd            10           0            0            1156         1156           0.62%         
BatchNormalization 3            0            0            750          750            0.41%         
MaxPool            1            0            0            725          725            0.39%         
Sub                16           22           0            415          437            0.24%         
ConvSigmoid        3            0            0            408          408            0.22%         
Pad                1            0            0            390          390            0.21%         
Clip               6            0            0            348          348            0.19%         
ConvClip           3            0            0            337          337            0.18%         
ReduceMax          1            276          0            0            276            0.15%         
Expand             3            269          0            0            269            0.15%         
Sigmoid            3            0            0            197          197            0.11%         
ConvExGelu         1            0            0            145          145            0.08%         
Log                1            94           0            0            94             0.05%         
Div                2            30           0            37           67             0.04%         
Resize             1            0            0            53           53             0.03%         
Cast               1            24           0            0            24             0.01%         
InputOperator      2            15           0            0            15             0.01%         
OutputOperator     3            12           0            0            12             0.01%         
Tile               1            10           0            0            10             0.01%         
---------------------------------------------------------------------------------------------------
Total                           82654        0            102352       185006        
---------------------------------------------------------------------------------------------------
```

为了在板端使用，算子使用C API开发，推理代码也由C实现，并封装为Python可调用的形式。C推理的过程只涉及纯粹的模型推理，数据准备、预处理和后处理等均在Python中完成。
